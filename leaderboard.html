<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard - Jofa Mining</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Header Styles */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background-color: #208de3;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .header-item {
      flex: 1;
      display: flex;
      align-items: center;
    }
    
    .header-center {
      justify-content: center;
      text-align: center;
    }
    
    .header-right {
      justify-content: flex-end;
    }
    
    .notification-icon {
      position: relative;
      cursor: pointer;
      font-size: 1.2rem;
      color: #f6e05e;
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #e53e3e;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .notification-dropdown {
      position: absolute;
      top: 50px;
      left: 15px;
      width: 320px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      color: #2d3748;
      max-height: 500px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      border: 1px solid #e2e8f0;
    }
    
    .notification-dropdown.show {
      display: block;
    }
    
    .notification-item {
      padding: 14px 16px;
      border-bottom: 1px solid #edf2f7;
      transition: all 0.2s;
    }
    
    .notification-item:hover {
      background-color: #f7fafc;
    }
    
    .notification-item.unread {
      background-color: #ebf8ff;
      border-left: 4px solid #3182ce;
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-title {
      font-weight: 600;
      color: #2b6cb0;
      margin-bottom: 4px;
    }
    
    .notification-message {
      font-size: 0.9rem;
      color: #4a5568;
      margin-bottom: 6px;
    }
    
    .notification-time {
      font-size: 0.75rem;
      color: #718096;
      display: flex;
      align-items: center;
    }
    
    .notification-time i {
      margin-right: 4px;
      font-size: 0.7rem;
      color: #f6ad55;
    }
    
    .balance-amount {
      font-weight: bold;
      font-size: 1.1rem;
      color: #f6e05e;
    }
    
    .username {
      font-weight: bold;
      color: #f6e05e;
    }

    /* Footer Styles */
    .app-footer {
      background-color: #208de3;
      color: white;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    }
    
    .footer-nav {
      display: flex;
      justify-content: space-around;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .footer-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      text-decoration: none;
      font-size: 0.7rem;
      transition: all 0.2s;
    }
    
    .footer-link i {
      font-size: 1.2rem;
      margin-bottom: 5px;
      color: #f6e05e;
    }
    
    .footer-link:hover {
      color: #f6e05e;
      transform: translateY(-2px);
    }

    /* Leaderboard Specific Styles */
    .leaderboard-card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      margin-bottom: 80px;
    }
    
    .rank-1 { background-color: #FFD700 !important; } /* Gold */
    .rank-2 { background-color: #C0C0C0 !important; } /* Silver */
    .rank-3 { background-color: #CD7F32 !important; } /* Bronze */
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Adjust container padding to account for fixed footer */
    .container {
      padding-bottom: 80px;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header Section -->
  <header class="app-header">
    <div class="header-item">
      <div class="notification-icon" id="notificationIcon">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-item">
            <div class="text-center py-4 text-gray-500">
              <i class="fas fa-spinner fa-spin"></i> Loading announcements...
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="header-item header-center">
      <div>
        <div>Your Balance</div>
        <div class="balance-amount" id="headerBalance">0.00 Jofa</div>
      </div>
    </div>
    
    <div class="header-item header-right">
      <div class="username" id="headerUsername">Loading...</div>
    </div>
  </header>

  <!-- Leaderboard Content -->
  <div class="container mx-auto p-1">
    <!-- Leaderboard Section -->
    <div class="leaderboard-card bg-white p-6 rounded-xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">
          <i class="fas fa-crown mr-2"></i>Top 100 Miners
        </h2>
        <div class="flex items-center space-x-2">
          <i class="fas fa-sync-alt cursor-pointer hover:text-blue-500" id="refreshButton"></i>
          <span class="text-sm text-gray-500" id="lastUpdated"></span>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-blue-500 text-white">
            <tr>
              <th class="py-3 px-4 rounded-tl-lg">Rank</th>
              <th class="py-3 px-4 text-left">Miner</th>
              <th class="py-3 px-4">Total Jofa</th>
              
            </tr>
          </thead>
          <tbody id="leaderboard" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="3" class="py-8">
                <div class="loading-spinner"></div>
                <p class="text-center mt-2 text-gray-600">Loading leaderboard...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="flex justify-between items-center mt-4">
        <p id="totalUsers" class="text-gray-600"></p>
        <p id="currentUserRank" class="text-blue-600 font-medium"></p>
      </div>
    </div>
  </div>

   <!-- Footer Section -->
  <footer class="app-footer">
    <nav class="footer-nav">
      <a href="mining.html" class="footer-link">
        <i class="fas fa-digging"></i>
        <span>Mining</span>
      </a>
      <a href="leaderboard.html" class="footer-link">
        <i class="fas fa-trophy"></i>
        <span>Leaderboard</span>
      </a>
      <a href="dashboard.html" class="footer-link">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
      </a>
 <a href="whitepaper.html" class="footer-link">
        <i class="fas fa-file"></i>
        <span>White Paper</span>
      </a>
<a href="firestreak.html" class="footer-link">
        <i class="fas fa-fire"></i>
        <span>Firestreaks</span>
      </a>
    </nav>
  </footer>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC7f9y43FTWklNNYVE5TrEKoqlSMt3Nv8U",
      authDomain: "simulatedminingapp.firebaseapp.com",
      projectId: "simulatedminingapp",
      storageBucket: "simulatedminingapp.appspot.com",
      messagingSenderId: "1075873844477",
      appId: "1:1075873844477:web:4b16da1ccb420ccb25c294"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const leaderboard = document.getElementById("leaderboard");
    const totalUsers = document.getElementById("totalUsers");
    const currentUserRank = document.getElementById("currentUserRank");
    const refreshButton = document.getElementById("refreshButton");
    const lastUpdated = document.getElementById("lastUpdated");
    const headerBalance = document.getElementById("headerBalance");
    const headerUsername = document.getElementById("headerUsername");
    const notificationIcon = document.getElementById("notificationIcon");
    const notificationBadge = document.getElementById("notificationBadge");
    const notificationDropdown = document.getElementById("notificationDropdown");

    // Global variables
    let currentUserId = null;
    let unsubscribeUserData = null;
    let unsubscribeAnnouncements = null;
    let unreadAnnouncements = 0;
    let lastSeenAnnouncementTime = null;

    // Auth state listener
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUserId = user.uid;
        
        // Set up real-time listener for user data
        unsubscribeUserData = db.collection("users").doc(user.uid)
          .onSnapshot(doc => {
            if (doc.exists) {
              const userData = doc.data();
              updateHeaderInfo(user, userData);
            }
          });
        
        // Load announcements
        loadAnnouncements();
        
        // Load leaderboard
        loadLeaderboard();
      }
    });

    // Notification functionality
    notificationIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationDropdown.classList.toggle('show');
      
      if (notificationDropdown.classList.contains('show')) {
        markNotificationsAsRead();
      }
    });

    document.addEventListener('click', function() {
      notificationDropdown.classList.remove('show');
    });

    function markNotificationsAsRead() {
      lastSeenAnnouncementTime = new Date();
      localStorage.setItem('lastSeenAnnouncementTime', lastSeenAnnouncementTime.toISOString());
      
      const unreadItems = document.querySelectorAll('.notification-item.unread');
      unreadItems.forEach(item => {
        item.classList.remove('unread');
      });
      
      unreadAnnouncements = 0;
      updateNotificationBadge();
    }

    function updateNotificationBadge() {
      if (unreadAnnouncements > 0) {
        notificationBadge.textContent = unreadAnnouncements;
        notificationBadge.style.display = 'flex';
      } else {
        notificationBadge.style.display = 'none';
      }
    }

    function updateHeaderInfo(user, userData) {
      headerUsername.textContent = userData.username || user.email.split('@')[0];
      
      // Update balance with animation if it changed
      const newBalance = (userData.totalEarned || 0).toFixed(2) + ' Jofa';
      if (headerBalance.textContent !== newBalance) {
        headerBalance.textContent = newBalance;
        headerBalance.classList.add('balance-updated');
        setTimeout(() => {
          headerBalance.classList.remove('balance-updated');
        }, 500);
      }
    }

    // Load announcements from Firestore
    function loadAnnouncements() {
      const storedTime = localStorage.getItem('lastSeenAnnouncementTime');
      lastSeenAnnouncementTime = storedTime ? new Date(storedTime) : new Date(0);
      
      unsubscribeAnnouncements = db.collection("announcements")
        .orderBy("createdAt", "desc")
        .limit(20)
        .onSnapshot(snapshot => {
          if (snapshot.empty) {
            notificationDropdown.innerHTML = `
              <div class="notification-item">
                <div class="text-center py-4 text-gray-500">
                  <i class="far fa-bell-slash"></i> No announcements yet
                </div>
              </div>
            `;
            return;
          }
          
          notificationDropdown.innerHTML = '';
          unreadAnnouncements = 0;
          
          snapshot.forEach(doc => {
            const announcement = doc.data();
            const announcementTime = announcement.createdAt.toDate();
            const isUnread = announcementTime > lastSeenAnnouncementTime;
            
            if (isUnread) {
              unreadAnnouncements++;
            }
            
            const notificationItem = document.createElement('div');
            notificationItem.className = `notification-item ${isUnread ? 'unread' : ''}`;
            
            notificationItem.innerHTML = `
              <div class="notification-title">${announcement.title}</div>
              <div class="notification-message">${announcement.message}</div>
              <div class="notification-time">
                <i class="far fa-clock"></i> ${formatTime(announcement.createdAt)}
              </div>
            `;
            
            notificationDropdown.appendChild(notificationItem);
          });
          
          updateNotificationBadge();
        }, error => {
          console.error("Error loading announcements:", error);
          notificationDropdown.innerHTML = `
            <div class="notification-item">
              <div class="text-center py-4 text-red-500">
                <i class="fas fa-exclamation-triangle"></i> Error loading announcements
              </div>
            </div>
          `;
        });
    }

    function formatTime(timestamp) {
      if (!timestamp) return "";
      const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);
      
      let interval = Math.floor(seconds / 31536000);
      if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";
      
      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";
      
      interval = Math.floor(seconds / 86400);
      if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
      
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
      
      interval = Math.floor(seconds / 60);
      if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
      
      return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s") + " ago";
    }

    // Format numbers
    function formatNumber(num) {
      return num ? num.toLocaleString() : "0";
    }

    // Load leaderboard data
    async function loadLeaderboard() {
      try {
        // Show loading state
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="py-8">
              <div class="loading-spinner"></div>
              <p class="text-center mt-2 text-gray-600">Loading leaderboard...</p>
            </td>
          </tr>`;

        // 1. Get top 100 miners
        const queryField = "totalEarned";
        const snapshot = await db.collection("users")
          .orderBy(queryField, "desc")
          .limit(100)
          .get();

        // 2. Get total user count
        const allUsers = await db.collection("users").get();
        const totalCount = allUsers.size;

        // 3. Get current user's data
        let currentUserData = null;
        if (currentUserId) {
          const currentUserDoc = await db.collection("users").doc(currentUserId).get();
          currentUserData = currentUserDoc.exists ? currentUserDoc.data() : null;
        }

        // Update UI
        updateLastUpdatedTime();
        totalUsers.innerHTML = `<i class="fas fa-users mr-2"></i>Total Miners: ${formatNumber(totalCount)}`;
        
        // Populate leaderboard
        leaderboard.innerHTML = '';
        
        if (snapshot.empty) {
          leaderboard.innerHTML = `
            <tr>
              <td colspan="4" class="py-4 text-gray-500 text-center">
                <i class="fas fa-info-circle mr-2"></i>No miners yet
              </td>
            </tr>`;
        } else {
          // Create array for sorting
          const miners = [];
          snapshot.forEach(doc => {
            miners.push({
              id: doc.id,
              ...doc.data()
            });
          });

          // Display all miners
          miners.forEach((user, index) => {
            const isCurrentUser = user.id === currentUserId;
            const earnings = user.totalEarned || user.tokensEarned || 0;
            
            const row = document.createElement("tr");
            row.className = `hover:bg-gray-50 ${isCurrentUser ? 'bg-blue-50 font-medium' : ''} ${index < 3 ? `rank-${index+1}` : ''}`;
            
            row.innerHTML = `
              <td class="py-3 px-4 text-center">
                ${index + 1}
                ${index < 3 ? `<i class="fas fa-medal ml-1"></i>` : ''}
              </td>
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-8 w-8 rounded-full ${isCurrentUser ? 'bg-blue-100' : 'bg-gray-200'} flex items-center justify-center">
                    <i class="fas fa-user ${isCurrentUser ? 'text-blue-500' : 'text-gray-600'}"></i>
                  </div>
                  <div class="ml-3">
                    <p class="font-medium">${user.username || "Anonymous"}</p>
                    ${isCurrentUser ? '<span class="text-xs bg-blue-100 text-blue-800 px-1 rounded">YOU</span>' : ''}
                  </div>
                </div>
              </td>
              <td class="py-3 px-4 text-center">
                ${earnings.toFixed(2)} <span class="text-blue-500">Jofa</span>
              `;
              
            leaderboard.appendChild(row);
          });

          // Update current user rank if available
          if (currentUserData) {
            const userEarnings = currentUserData.totalEarned || currentUserData.tokensEarned || 0;
            const betterMiners = miners.filter(m => (m.totalEarned || m.tokensEarned || 0) > userEarnings).length;
            currentUserRank.textContent = `Your rank: #${betterMiners + 1}`;
          }
        }
      } catch (error) {
        console.error("Leaderboard error:", error);
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="py-4 text-red-500 text-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>Error loading data
            </td>
          </tr>`;
      }
    }

    function updateLastUpdatedTime() {
      lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }

    // Refresh button
    refreshButton.addEventListener('click', loadLeaderboard);

    // Clean up listeners when page unloads
    window.addEventListener('beforeunload', () => {
      if (unsubscribeUserData) unsubscribeUserData();
      if (unsubscribeAnnouncements) unsubscribeAnnouncements();
    });

    // Refresh every 30 seconds
    setInterval(loadLeaderboard, 360000);
  </script>
</body>
</html>